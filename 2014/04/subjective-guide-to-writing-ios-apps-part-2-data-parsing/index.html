<!DOCTYPE HTML> <html> <head> <meta charset="utf-8"> <title>Subjective guide to writing iOS Apps - Part 2 Data Parsing - Krzysztof Zabłocki</title> <meta name="author" content="Krzysztof Zabłocki"> <meta name=”twitter:site” content=”@merowing_> <meta name="description" content="Subjective guide to writing iOS Apps - Part 2 Data Parsing When it comes to architecture choices, the model layer is very important, flexible data &hellip;"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link href="/atom.xml" rel="alternate" title="Krzysztof Zabłocki" type="application/atom+xml"> <link rel="canonical" href="http://merowing.info/2014/04/subjective-guide-to-writing-ios-apps-part-2-data-parsing"> <link href="/favicon.png" rel="shortcut icon"> <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css"> <link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script> <style type="text/css">
  .fancybox-wrap { position: fixed !important; }
  .fancybox-opened {
    -webkit-border-radius: 4px !important;
       -moz-border-radius: 4px !important;
            border-radius: 4px !important;
  }
  .fancybox-close, .fancybox-prev span, .fancybox-next span {
    background-color: transparent !important;
    border: 0 !important;
  }
</style> <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-29400340-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();

		$('a').click(function() { 
			var $a = $(this); var href = $a.attr('href');
			// see if the link is external 
			if ( (href.match(/^http/)) && (! href.match(document.domain)) ) {

			// if so, register an event
			var category = 'outgoing'; // set this to whatever you want
			var event = 'click'; // set this to whatever you want
			var label = href; // set this to whatever you want
			pageTracker._trackEvent(category, event, href);
			}});
	</script> </head> <body> <div class="container"> <div class="left-col"> <div class="intrude-less"> <header id="header" class="inner"><div class="profilepic"> <script src="/javascripts/md5.js"></script> <script type="text/javascript">
		$(function(){
			$('.profilepic').append("<a href='http://twitter.com/merowing_'><img src='http://www.gravatar.com/avatar/" + MD5("krzysztof.zablocki@pixle.pl") + "?s=120' alt='Profile Picture' style='width: 120px; float: left; margin: 0px 15px 15px 0px;' /></a> <div class='header_bio'><a href='/about/''>Krzysztof Zabłocki - Software Engineer.</a></div>");
		});
	</script> </div> <nav id="main-nav"><ul class="main"> <br/> <br/> <div class="indie_apps" style="clear:both;"> <a href="http://appstore.com/foldify"><img class="app_poster" src="http://www.merowing.info/images/foldify.png" alt="Foldify"></a> <a href="http://appstore.com/foldifyzoo"><img class="app_poster" src="http://www.merowing.info/images/foldifyzoo.png" alt="Foldify Zoo"></a> <a href="http://appstore.com/foldifydino"><img class="app_poster" src="http://www.merowing.info/images/foldifydino.png" alt="Foldify Dino"></a> <a href="https://itunes.apple.com/us/app/storest-kids-love-playing/id926102013?mt=8"><img class="app_poster" src="http://www.merowing.info/images/storest.png" alt="Bord"></a> <a href="http://appstore.com/bord"><img class="app_poster" src="http://www.merowing.info/images/bord.png" alt="Storest"></a> <br/> <br/> </div> <li><a href="/about">About me</a></li> <li><a href="/speaking">Speaking</a></li> <li><a href="/">Blog</a></li> <li><a href="/blog/archives">Archives</a></li> </ul> </nav> <nav id="popular"> <section> <h4>Recommended</h4> <li class="related"><a href="/2014/10/how-do-i-work/">How do I Work?</a></li> <li class="related"><a href="/2014/03/refactoring-tricks">Refactoring tricks</a> and <a href="/2014/02/ios-developer-tools">Developer Tools</a></li> <li class="related"><a href="/2012/04/drawing-smooth-lines-with-cocos2d-ios-inspired-by-paper">Drawing smooth lines</a></li> <li class="related"><a href="https://github.com/krzysztofzablocki/KZPropertyMapper">Data Parsing</a> and <a href="https://github.com/krzysztofzablocki/KZBootstrap">Project bootstrap</a></li> </section> </nav> <nav id="sub-nav"> <div class="social"> <a class="email" href="mailto:krzysztof.zablocki@pixle.pl" title="Email">Email</a> <a class="facebook" href="http://www.facebook.com/100000315956630" title="Facebook">Facebook</a> <a class="twitter" href="http://twitter.com/merowing_" title="Twitter">Twitter</a> <a class="github" href="https://github.com/krzysztofzablocki" title="GitHub">GitHub</a> <a class="linkedin" href="http://www.linkedin.com/profile/view?id=90077810" title="LinkedIn">LinkedIn</a> <a class="rss" href="/atom.xml" title="RSS">RSS</a> </div> </nav></header> </div> </div> <div class="mid-col"> <div class="mid-col-container"> <div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <h1 class="title" itemprop="name">Subjective guide to writing iOS Apps - Part 2 Data Parsing</h1> <div class="entry-content" itemprop="articleBody"><p>When it comes to architecture choices, the model layer is very important, flexible data parsing will allow us to add new types of objects easily, so making a mistake in this part of our app might lead to serious problems in the future.</p> <p>Let&#8217;s look at how we could create a simple yet flexible architecture for our model layer.</p> <h2>Design</h2> <p>What I like to do is create a modular architecture, one in which I can add new types of objects without modifying the core of the app, that way I can expand the application without much fuss.</p> <p>Since UI will come later in this series, I&#8217;ll write this part using tests.</p> <h3>Choices</h3> <p>Let&#8217;s start with a few choices before we design the architecture:</p> <ul> <li><a href="https://github.com/krzysztofzablocki/KZPropertyMapper">KZPropertyMapper</a> for data mapping - because it&#8217;s simple.</li> <li>CoreData for data persistence - because it&#8217;s a very common need/choice in commercial apps.</li> <li><a href="https://github.com/rentzsch/mogenerator">mogenerator</a> - as it&#8217;s useful for creating human / machine files</li> <li><a href="https://github.com/magicalpanda/MagicalRecord">Magical Record</a> - since we already know CoreData let&#8217;s use a popular wrapper to help us out.</li> <li><a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a> - a very popular library that I&#8217;ll use for fetching data.</li> <li><a href="https://github.com/AliSoftware/OHHTTPStubs">OHHTTPStubs</a> - this is not backend tutorial, so we&#8217;ll stub server responses.</li> <li><a href="https://github.com/allending/Kiwi">Kiwi</a> for tests -my favorite.</li> </ul> <p>I&#8217;m not a huge fan of CoreData, but It gives me a nice way to have separation of concern. When I use a Fetched Results Controller my UI can be automatically updated and I end up having something like this:</p> <p><img src="http://merowing.info/uploads/2014/04/Flow.png" width="400" height="57"></p> <p>In this article I&#8217;ll talk about the data path. <a href="https://github.com/krzysztofzablocki/KZBootstrap">Grab source code from GitHub</a></p> <h2>Implementation</h2> <p>First I start by setting up a project with <a href="https://github.com/krzysztofzablocki/crafter">crafter</a></p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. KZBootstrap
</span><span class='line'>2. KZBootstrapTests
</span><span class='line'>Which target should I use for default?
</span><span class='line'>1
</span><span class='line'>1. KZBootstrap
</span><span class='line'>2. KZBootstrapTests
</span><span class='line'>Which target should I use for tests?
</span><span class='line'>2
</span><span class='line'>do you want to add networking? [y/n]
</span><span class='line'>y
</span><span class='line'>do you want to add coredata? [y/n]
</span><span class='line'>y
</span><span class='line'>do you want to add kiwi? [y/n]
</span><span class='line'>y
</span><span class='line'>duplicating configurations
</span><span class='line'>setting up variety of options
</span><span class='line'>preparing git ignore
</span><span class='line'>preparing pod file
</span><span class='line'>adding scripts
</span><span class='line'>Finished.</span></code></pre></td></tr></table></div></figure> </div> <p>Using <a href="https://github.com/krzysztofzablocki/crafter">crafter</a> I now have all of my preferred libraries and custom warning levels without wasting time doing manual configuration.</p> <h3>Fetching</h3> <p>We won&#8217;t be using a real backend server, instead we&#8217;ll use the OHHTTPStubs library to stub network requests and return canned JSON responses. The library also provides us with simulated network speed (How cool is that?).</p> <p>For this part we can get away with an extra simple DataProvider concept, it just needs to satisfy a few simple requirements:</p> <ul> <li>it should allow stubbing fake data for an arbitrary URL (because we don&#8217;t have backend)</li> <li>it should return operations that can be cancelled</li> </ul> <p>We can write tests for these 2 conditions like this:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">it</span><span class="p">(</span><span class="s">@&quot;should fetch data from an arbitrary URL&quot;</span><span class="p">,</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">__block</span> <span class="kt">BOOL</span> <span class="n">success</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[</span><span class="n">sut</span> <span class="nl">dataForURL:</span><span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://fake.url&quot;</span><span class="p">]</span> <span class="nl">withSuccessBlock:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">responseData</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">success</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="nl">andFailureBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[[</span><span class="n">expectFutureValue</span><span class="p">(</span><span class="err">@</span><span class="p">(</span><span class="n">success</span><span class="p">))</span> <span class="n">shouldEventually</span><span class="p">]</span> <span class="n">beTrue</span><span class="p">];</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="n">it</span><span class="p">(</span><span class="s">@&quot;should return operations that can be canceled&quot;</span><span class="p">,</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">__block</span> <span class="kt">BOOL</span> <span class="n">executed</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">id</span><span class="o">&lt;</span><span class="n">KZBCancelableOperation</span><span class="o">&gt;</span> <span class="n">operation</span> <span class="o">=</span> <span class="p">[</span><span class="n">sut</span> <span class="nl">dataForURL:</span><span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://fake.url&quot;</span><span class="p">]</span> <span class="nl">withSuccessBlock:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">responseData</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">executed</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="nl">andFailureBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">executed</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">operation</span> <span class="n">cancel</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">expectFutureValue</span><span class="p">(</span><span class="err">@</span><span class="p">(</span><span class="n">executed</span><span class="p">))</span> <span class="n">shouldNotEventually</span><span class="p">]</span> <span class="n">beTrue</span><span class="p">];</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>In the first test we only care that it succeeds, in the second test I&#8217;m making sure that the operation can be cancelled.</p> <p>Now to make the first test pass, we want to stub our network requests by using OHHTTPStubs:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setupStubs</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">OHHTTPStubs</span> <span class="n">removeAllStubs</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">mapping</span> <span class="nl">enumerateKeysAndObjectsUsingBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">urlPath</span><span class="p">,</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">OHHTTPStubs</span> <span class="nl">stubRequestsPassingTest:</span><span class="o">^</span><span class="kt">BOOL</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">BOOL</span> <span class="n">equal</span> <span class="o">=</span> <span class="p">[</span><span class="n">request</span><span class="p">.</span><span class="n">URL</span><span class="p">.</span><span class="n">absoluteString</span> <span class="nl">isEqualToString:</span><span class="n">urlPath</span><span class="p">];</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">equal</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">withStubResponse:</span><span class="o">^</span><span class="n">OHHTTPStubsResponse</span> <span class="o">*</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">OHHTTPStubsResponse</span> <span class="o">*</span><span class="k">const</span> <span class="n">response</span> <span class="o">=</span> <span class="p">[</span><span class="n">OHHTTPStubsResponse</span> <span class="nl">responseWithFileAtPath:</span><span class="n">OHPathForFileInBundle</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="nb">nil</span><span class="p">)</span> <span class="nl">statusCode:</span><span class="mi">200</span> <span class="nl">headers:</span><span class="err">@</span><span class="p">{</span><span class="s">@&quot;Content-Type&quot;</span> <span class="o">:</span> <span class="s">@&quot;text/json&quot;</span><span class="p">}];</span>
</span><span class='line'>      <span class="n">response</span><span class="p">.</span><span class="n">responseTime</span> <span class="o">=</span> <span class="n">OHHTTPStubsDownloadSpeed3G</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Here I setup all the stubbed network responses by using a mapping dictionary in form URLPath : FileName.</p> <p>I also setup the stub to simulate the speed of a 3G connection since I want real async tests as we don&#8217;t currently have a real UI</p> <p>(In most cases you want to make tests run as fast as possible so that whole test-suite takes the minimum amount of time, since you&#8217;ll be running them very often).</p> <p>Implementing dataForURL is easy enough:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">KZBCancelableOperation</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">dataForURL:</span><span class="p">(</span><span class="n">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="nv">url</span> <span class="nf">withSuccessBlock:</span><span class="p">(</span><span class="n">KZBSuccessBlock</span><span class="p">)</span><span class="nv">successBlock</span> <span class="nf">andFailureBlock:</span><span class="p">(</span><span class="n">KZBFailureBlock</span><span class="p">)</span><span class="nv">failureBlock</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">id</span> <span class="n">requestOperation</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AFHTTPRequestOperationManager</span> <span class="n">manager</span><span class="p">]</span> <span class="nl">GET:</span><span class="n">url</span><span class="p">.</span><span class="n">absoluteString</span> <span class="nl">parameters:</span><span class="nb">nil</span> <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">successBlock</span><span class="p">(</span><span class="n">responseObject</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">operation</span><span class="p">.</span><span class="n">isCancelled</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">failureBlock</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'>  <span class="n">NSAssert</span><span class="p">([</span><span class="n">requestOperation</span> <span class="nl">respondsToSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="n">cancel</span><span class="p">)],</span> <span class="s">@&quot;Returned operation doesn&#39;t support KZBCancelableOperation protocol&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">requestOperation</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Here I am using AFNetworking to do a simple fetch.</p> <ul> <li>I don&#8217;t want a cancelled action to callback my completion blocks so I ignore cancelled operations with a guard clause.</li> <li>I want to make sure requestOperation supports canceling.</li> <li>Since I don&#8217;t have any value in exposing AFNetworking internal classes to my code I&#8217;ll be using my cancelable protocol.</li> </ul> <h3>Parsing data</h3> <p>When it comes to parsing data, I&#8217;d like to make sure this implementation handles a few requirements:</p> <ol> <li>Easy to modify source format, if I need to change from JSON to something else, then that shouldn&#8217;t be a massive endeavor.</li> <li>I&#8217;d like to be able to add new types of objects without modifying the parsing core. Ideally I would just add a class and have it working.</li> <li>Parsing should be very simple, preferably with little-to-no code.</li> </ol> <p>Let&#8217;s look how we can create a design that will take care of all of these requirements:</p> <h4>Source format</h4> <p>This requirement is very simple to satisfy since we&#8217;ll be using KZPropertyMapper for mapping.</p> <p>It doesn&#8217;t rely on JSON/XML or any other format. It uses native data structures, so the only thing we need to make sure of is that our parser converts the source format into native types before passing the data to KZPropertyMapper.</p> <h4>Supporting new classes</h4> <p>This is the requirement that affects the design of this architecture the most.</p> <p>I want to drop-in a new class to the project, and <em>&#8216;somehow&#8217;</em> have it picked up by the parser and handled.</p> <h5>Protocol</h5> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@protocol</span> <span class="nc">KZBParsableObjectProtocol</span> <span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span>
</span><span class='line'><span class="err">@</span><span class="n">required</span>
</span><span class='line'><span class="o">+</span> <span class="p">(</span><span class="n">NSString</span><span class="o">*</span><span class="p">)</span><span class="n">serverType</span><span class="p">;</span>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSString</span><span class="o">*</span><span class="p">)</span><span class="nf">serverIDPropertyName</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">updateFromDictionary:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">dictionary</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Here we decide on 3 main features:</p> <ol> <li>We can define our own mapping for serverTypes, doing ORM with 1:1 naming is usually ugly, especially if you have to support multiple platforms.</li> <li>We select which property will be used for mapping serverTypes.</li> <li>Each object knows how to update itself from an NSDictionary*. In proper projects this might be a good place to return an error at the core parsing level, especially since KZPropertyMapper can generate validation errors for you.</li> </ol> <p>It&#8217;s a nice simple protocol, but it doesn&#8217;t help us automatically support any new classes.</p> <h5>Finding parsable classes</h5> <p>It&#8217;s actually quite simple to use the Obj-C runtime to get a list of all classes that conform to our protocol.</p> <p>Let&#8217;s start with being able to find classes conforming to an arbitrary protocol:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="n">it</span><span class="p">(</span><span class="s">@&quot;should be able to find classes conforming to specific protocol&quot;</span><span class="p">,</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[[[</span><span class="n">KZBParsingHelper</span> <span class="nl">findClassesConformingToProtocol:</span><span class="err">@</span><span class="n">protocol</span><span class="p">(</span><span class="n">KZBParsableObjectProtocol</span><span class="p">)]</span> <span class="n">should</span><span class="p">]</span> <span class="nl">equal:</span><span class="err">@</span><span class="p">[</span><span class="n">KZBTestParsableClass</span><span class="p">.</span><span class="n">class</span><span class="p">]];</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>In order to make this simple test pass, we need to get our hands a little bit dirty and use the straight C API of the Obj-C runtime.</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nf">findClassesConformingToProtocol:</span><span class="p">(</span><span class="n">Protocol</span> <span class="o">*</span><span class="p">)</span><span class="nv">protocol</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="c1">//! 1</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">numberOfClasses</span> <span class="o">=</span> <span class="n">objc_getClassList</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Class</span> <span class="o">*</span><span class="n">classes</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//! 2</span>
</span><span class='line'>  <span class="n">classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">Class</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Class</span><span class="p">)</span> <span class="o">*</span> <span class="n">numberOfClasses</span><span class="p">);</span>
</span><span class='line'>  <span class="n">objc_getClassList</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">numberOfClasses</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">conformingClasses</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">NSInteger</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numberOfClasses</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Class</span> <span class="n">lClass</span> <span class="o">=</span> <span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'><span class="c1">//! 3</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">class_conformsToProtocol</span><span class="p">(</span><span class="n">lClass</span><span class="p">,</span> <span class="n">protocol</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">[</span><span class="n">conformingClasses</span> <span class="nl">addObject:</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">free</span><span class="p">(</span><span class="n">classes</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">[</span><span class="n">conformingClasses</span> <span class="n">copy</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>What happens here?</p> <ol> <li>First we need to establish the total number of classes in our application, so that we can allocate enough memory to hold them all.</li> <li>We allocate memory for our classes array and then ask the runtime to fill this allocated memory with the classes.</li> <li>While we are enumerating over all classes we need to use</li> </ol> <div> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">class_conformsToProtocol</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Instead of NSObject:</p> <div> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="n">class</span> <span class="nl">conformsToProtocol:</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>This is because <strong>not all</strong> classes have to inherit from NSObject or implement the NSObject Protocol and that method will fail.</p> <p>Next we&#8217;d like to be able to grab a class corresponding to a specific serverType value:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">it</span><span class="p">(</span><span class="s">@&quot;should be able to query class for a serverType&quot;</span><span class="p">,</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">[[[</span><span class="n">KZBParsingHelper</span> <span class="nl">findClassesConformingToProtocol:</span><span class="err">@</span><span class="n">protocol</span><span class="p">(</span><span class="n">KZBParsableObjectProtocol</span><span class="p">)]</span> <span class="n">should</span><span class="p">]</span> <span class="nl">contain:</span><span class="n">KZBTestParsableClass</span><span class="p">.</span><span class="n">class</span><span class="p">];</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Now querying all the classes every time someone asks for a serverType would be <em>very wasteful and not very smart</em>.</p> <p>Let&#8217;s generate a serverType - class mapping only once when the KZBParsingHelper is first used:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">//! 1.</span>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">initialize</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span> <span class="n">setupServerTypeToClassMapping</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setupServerTypeToClassMapping</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="c1">//! 2.</span>
</span><span class='line'>  <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">classMapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableDictionary</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">Class</span> <span class="n">lClass</span> <span class="k">in</span> <span class="p">[</span><span class="n">self</span> <span class="nl">findClassesConformingToProtocol:</span><span class="err">@</span><span class="n">protocol</span><span class="p">(</span><span class="n">KZBParsableObjectProtocol</span><span class="p">)])</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">classMapping</span><span class="p">[[(</span><span class="kt">id</span><span class="p">)</span><span class="n">lClass</span> <span class="n">serverType</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lClass</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="c1">//! 3.</span>
</span><span class='line'>  <span class="n">NSArray</span> <span class="o">*</span><span class="k">const</span> <span class="n">serverTypes</span> <span class="o">=</span> <span class="n">classMapping</span><span class="p">.</span><span class="n">allValues</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NSAssert</span><span class="p">([</span><span class="n">serverTypes</span> <span class="n">count</span><span class="p">]</span> <span class="o">==</span> <span class="p">[[</span><span class="n">serverTypes</span> <span class="nl">valueForKeyPath:</span><span class="s">@&quot;@distinctUnionOfObjects.self&quot;</span><span class="p">]</span> <span class="n">count</span><span class="p">],</span> <span class="s">@&quot;serverType collision, there shouldn&#39;t be 2 classes using same serverType %@&quot;</span><span class="p">,</span> <span class="n">classMapping</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//! 4.</span>
</span><span class='line'>  <span class="n">objc_setAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">serverTypeToClassMappingKey</span><span class="p">,</span> <span class="n">classMapping</span><span class="p">,</span> <span class="n">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">Class</span><span class="p">)</span><span class="nf">classForServerType:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">serverType</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="c1">//! 5.</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">[</span><span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">serverTypeToClassMappingKey</span><span class="p">)</span> <span class="nl">objectForKey:</span><span class="n">serverType</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Let&#8217;s elaborate:</p> <ol> <li>initialize is called when the class is first referenced, so when you first try to use any of the methods available in KZBParsingHelper it will execute.</li> <li>Create a simple mapping between a serverType and the class that can map it.</li> <li>Make sure that there aren&#8217;t any duplicate serverTypes, since that would be programmer mistake.</li> <li>Use associated objects to store the mappings against the class.</li> <li>Use associated objects to retrieve a mapping from the class.</li> </ol> <h5>Parser</h5> <p>Let&#8217;s define a simple DataParser protocol:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@protocol</span> <span class="nc">KZBParserProtocol</span> <span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">parseData:</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="nl">withCompletion:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">parsingInfo</span><span class="p">))</span><span class="n">completionBlock</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure> </div> <ol> <li>I don&#8217;t see a need to define data types at this level, I&#8217;d rather accept raw data and have the specific parser know how to handle it.</li> <li>Even if you wanted to do the parsing synchronously (really?) I believe this should still be designed as an async interface.</li> <li>Completion is called with error and parsingInfo, parsingInfo might be useful for specific parsers.</li> </ol> <h5>JSON Parser &amp; CoreData</h5> <p>Let&#8217;s implement a base JSON parser that can work with CoreData, this will be a base class for implementing format specific JSON parsers later on.</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">KZBJSONParser</span> : <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">KZBParserProtocol</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">processBody:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">jsonBody</span> <span class="nl">inContext:</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="n">localContext</span> <span class="nl">completion:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="p">))</span><span class="n">completionBlock</span> <span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Here we are adding one new method, subclasses can use it to define format specific parsing logic.</p> <p>The implementation looks like this:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@implementation</span> <span class="nc">KZBJSONParser</span>
</span><span class='line'><span class="c1">//! 1.</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">parseData:</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">jsonData</span> <span class="nf">withCompletion:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="p">))</span><span class="nv">completionBlock</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="c1">//! 2.</span>
</span><span class='line'>  <span class="n">NSParameterAssert</span><span class="p">(</span><span class="n">completionBlock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">__block</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">id</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">deserializeJSONData:</span><span class="n">jsonData</span> <span class="nl">error:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">completionBlock</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">__block</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">parserInfo</span><span class="p">;</span>
</span><span class='line'><span class="c1">//! 3.</span>
</span><span class='line'>  <span class="p">[</span><span class="n">MagicalRecord</span> <span class="nl">saveWithBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="n">localContext</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span> <span class="nl">processBody:</span><span class="n">obj</span>
</span><span class='line'>          <span class="nl">withCompletion:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">aError</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">aParserInfo</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">error</span> <span class="o">=</span> <span class="n">aError</span><span class="p">;</span>
</span><span class='line'>            <span class="n">parserInfo</span> <span class="o">=</span> <span class="n">aParserInfo</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span> <span class="nl">inContext:</span><span class="n">localContext</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span> <span class="nl">completion:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">success</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">aError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="n">aError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">error</span> <span class="o">=</span> <span class="n">pixle_NSErrorMake</span><span class="p">([</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;Saving to CoreData failed with error %@&quot;</span><span class="p">,</span> <span class="n">aError</span><span class="p">],</span> <span class="n">kErrorCodeInternal</span><span class="p">,</span> <span class="n">aError</span> <span class="o">?</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;parseError&quot;</span> <span class="o">:</span> <span class="n">aError</span><span class="p">}</span> <span class="o">:</span> <span class="nb">nil</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">completionBlock</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">parserInfo</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//! 4.</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">processBody:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">jsonBody</span> <span class="nf">withCompletion:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="p">))</span><span class="nv">completionBlock</span> <span class="nf">inContext:</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="nv">localContext</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark - Helpers</span>
</span><span class='line'><span class="c1">//! 5.</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">deserializeJSONData:</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">data</span> <span class="nf">error:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">**</span><span class="p">)</span><span class="nv">error</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">NSError</span> <span class="o">*</span><span class="n">ourError</span> <span class="o">=</span> <span class="n">pixle_NSErrorMake</span><span class="p">(</span><span class="s">@&quot;JSON data is nil&quot;</span><span class="p">,</span> <span class="n">kErrorCodeInternal</span><span class="p">,</span> <span class="nb">nil</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>      <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">ourError</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kt">id</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">JSONObjectWithData:</span><span class="n">data</span> <span class="nl">options:</span><span class="p">(</span><span class="n">NSJSONReadingOptions</span><span class="p">)</span><span class="mi">0</span> <span class="nl">error:</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure> </div> <ol> <li>Concrete implementation of the base method from the Parser protocol.</li> <li><strong>Parsing is an expensive operation</strong> and I&#8217;d like to enforce no-one calls it without caring about the results.</li> <li>Our JSON processing will happen on the CoreData context thread, and we&#8217;ll pass in the localContext as I prefer to be explicit when working with context objects.</li> <li>Stub method for subclasses.</li> <li>Helper method for deserialising JSON using NSJSONSerialization.</li> </ol> <p>Now to be able to progress from here:</p> <p>We need to know the JSON format coming from our servers.</p> <p>As nice as REST is, not every client you have to work with have proper REST services, sometimes you might need to handle custom endpoints.</p> <h3>Server API?</h3> <p>While I was lead dev at <a href="http://theappbusiness.com">TAB</a> one of our apps had a diff-like API:</p> <p>We would query an endpoint and we&#8217;d get a response with list of actions to execute on our iOS app.</p> <p>Let&#8217;s define something similar for our tests:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;serverId&quot;</span> <span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;serverType&quot;</span> <span class="p">:</span> <span class="s2">&quot;TextWidget&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;My test title&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;serverId&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;serverType&quot;</span><span class="p">:</span> <span class="s2">&quot;ImageWidget&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://goo.gl/IFSk4C&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}],</span>
</span><span class='line'>    <span class="nt">&quot;nextUrl&quot;</span> <span class="p">:</span> <span class="kc">null</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>We have 2 sections in our response:</p> <ol> <li>actions - this is an array of actions to execute in a specific order. Each action has a type and a payload.</li> <li>nextUrl - the next fetch request should use this url. This way we can drive the whole API flow and only hardcode the &#8216;start&#8217; endpoint in our app.</li> </ol> <p>Let&#8217;s implement a JSON Diff parser to handle our custom format, with some space for extensibility later on.</p> <h4>JSON Diff parser</h4> <p>The nice thing about our base JSON parser is the fact that we only need to override one method to implement our diff format:</p> <div> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">processBody:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">jsonBody</span> <span class="nf">withCompletion:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="p">))</span><span class="nv">completionBlock</span> <span class="nf">inContext:</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="nv">localContext</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Let&#8217;s define some simple requirements for our diff parser:</p> <ul> <li>should raise an exception for JSON format</li> <li>should succeed for proper JSON format</li> <li>should ignore non implemented actions</li> <li>should create a new object for the add action</li> </ul> <p>To satisfy the first 2 requirements we can write tests like this:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">//! 1.</span>
</span><span class='line'>  <span class="n">it</span><span class="p">(</span><span class="s">@&quot;should raise exception for corrupted JSON format&quot;</span><span class="p">,</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[[</span><span class="n">theBlock</span><span class="p">(</span><span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">[</span><span class="n">sut</span> <span class="nl">processBody:</span><span class="p">[</span><span class="n">sut</span> <span class="nl">deserializeJSONData:</span><span class="n">DataForDiffFile</span><span class="p">(</span><span class="n">invalid</span><span class="p">)</span> <span class="nl">error:</span><span class="nb">nil</span><span class="p">]</span> <span class="nl">withCompletion:</span><span class="o">^</span>
</span><span class='line'>      <span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">aError</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dictionary</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">}</span> <span class="nl">inContext:</span><span class="p">[</span><span class="n">NSManagedObjectContext</span> <span class="n">MR_context</span><span class="p">]];</span>
</span><span class='line'>    <span class="p">})</span> <span class="n">should</span><span class="p">]</span> <span class="n">raise</span><span class="p">];</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//! 2.</span>
</span><span class='line'>  <span class="n">it</span><span class="p">(</span><span class="s">@&quot;should succeed for proper JSON format&quot;</span><span class="p">,</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">__block</span> <span class="n">NSNumber</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="n">sut</span> <span class="nl">parseData:</span><span class="n">DataForDiffFile</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="nl">withCompletion:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dictionary</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">result</span> <span class="o">=</span> <span class="err">@</span><span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[[</span><span class="n">expectFutureValue</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="n">shouldEventually</span><span class="p">]</span> <span class="n">beYes</span><span class="p">];</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure> </div> <ol> <li>This test is not perfect as I had to manually deserialise JSON and use processBody instead of the standard method, this is due to having to raise an exception asynchronously, if you know how to write a test that can work with the default method, <a href="http://twitter.com/merowing_">send me a tweet</a>.</li> <li>We want to get a completion callback and make sure there weren&#8217;t any errors.</li> </ol> <p>We can make these 2 tests pass with a simple implementation like:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">processBody:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">jsonBody</span> <span class="nf">withCompletion:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="p">))</span><span class="nv">completionBlock</span> <span class="nf">inContext:</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="nv">localContext</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="nl">processBody:</span><span class="n">jsonBody</span> <span class="nl">withCompletion:</span><span class="n">completionBlock</span> <span class="nl">inContext:</span><span class="n">localContext</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">AssertTrueOrReturnBlock</span><span class="p">([</span><span class="n">jsonBody</span> <span class="nl">isKindOfClass:</span><span class="n">NSDictionary</span><span class="p">.</span><span class="n">class</span><span class="p">],</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">completionBlock</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">nextURL</span> <span class="o">=</span> <span class="n">jsonBody</span><span class="p">[</span><span class="s">@&quot;nextUrl&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">AssertTrueOrReturnBlock</span><span class="p">((</span><span class="kt">id</span><span class="p">)</span><span class="n">nextURL</span> <span class="o">==</span> <span class="p">[</span><span class="n">NSNull</span> <span class="n">null</span><span class="p">]</span> <span class="o">||</span> <span class="p">[</span><span class="n">nextURL</span> <span class="nl">isKindOfClass:</span><span class="n">NSString</span><span class="p">.</span><span class="n">class</span><span class="p">],</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">completionBlock</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSArray</span> <span class="o">*</span><span class="n">actions</span> <span class="o">=</span> <span class="n">jsonBody</span><span class="p">[</span><span class="s">@&quot;actions&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">AssertTrueOrReturnBlock</span><span class="p">([</span><span class="n">actions</span> <span class="nl">isKindOfClass:</span><span class="n">NSArray</span><span class="p">.</span><span class="n">class</span><span class="p">],</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">completionBlock</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">actions</span> <span class="nl">enumerateObjectsUsingBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">action</span><span class="p">,</span> <span class="n">NSUInteger</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">AssertTrueOrReturnBlock</span><span class="p">([</span><span class="n">action</span> <span class="nl">isKindOfClass:</span><span class="n">NSDictionary</span><span class="p">.</span><span class="n">class</span><span class="p">],</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>      <span class="n">completionBlock</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">AssertTrueOrReturnBlock</span><span class="p">([</span><span class="n">action</span><span class="p">[</span><span class="s">@&quot;type&quot;</span><span class="p">]</span> <span class="nl">isKindOfClass:</span><span class="n">NSString</span><span class="p">.</span><span class="n">class</span><span class="p">],</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>      <span class="n">completionBlock</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Here we assert on expected types using <a href="http://www.merowing.info/2013/07/expanded-use-of-asserts/#.Uz2g1K2Sx1M">my advanced asserts</a>, that way it won&#8217;t crash when compiled for release.</p> <p><strong>But</strong> this code already looks a little bit crowded, and not that flexible, so let&#8217;s refactor it to prepare for the next steps:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">processBody:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">jsonBody</span> <span class="nf">withCompletion:</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="p">))</span><span class="nv">completionBlock</span> <span class="nf">inContext:</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="nv">localContext</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">super</span> <span class="nl">processBody:</span><span class="n">jsonBody</span> <span class="nl">withCompletion:</span><span class="n">completionBlock</span> <span class="nl">inContext:</span><span class="n">localContext</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">AssertTrueOrReturnBlock</span><span class="p">([</span><span class="n">jsonBody</span> <span class="nl">isKindOfClass:</span><span class="n">NSDictionary</span><span class="p">.</span><span class="n">class</span><span class="p">],</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">completionBlock</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="c1">//! 1.</span>
</span><span class='line'>  <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">parsingInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableDictionary</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">processSections:</span><span class="n">jsonBody</span> <span class="nl">parsingInfo:</span><span class="n">parsingInfo</span> <span class="nl">inContext:</span><span class="n">localContext</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">completionBlock</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">parsingInfo</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">completionBlock</span><span class="p">(</span><span class="nb">nil</span><span class="p">,</span> <span class="n">parsingInfo</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nf">processSections:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">sections</span> <span class="nf">parsingInfo:</span><span class="p">(</span><span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">parsingInfo</span> <span class="nf">inContext:</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="nv">context</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">__block</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">oError</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[</span><span class="n">sections</span> <span class="nl">enumerateKeysAndObjectsUsingBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">section</span><span class="p">,</span> <span class="kt">id</span> <span class="n">sectionData</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">AssertTrueOrReturnBlock</span><span class="p">([</span><span class="n">section</span> <span class="nl">isKindOfClass:</span><span class="n">NSString</span><span class="p">.</span><span class="n">class</span><span class="p">],</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>      <span class="n">oError</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="c1">//! 2.</span>
</span><span class='line'>    <span class="kt">SEL</span> <span class="n">selector</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">selectorForHandlingSection:</span><span class="n">section</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">self</span> <span class="nl">respondsToSelector:</span><span class="n">selector</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">DDLogWarn</span><span class="p">(</span><span class="s">@&quot;Ignoring json diff section %@&quot;</span><span class="p">,</span> <span class="n">section</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">//! 3.</span>
</span><span class='line'>    <span class="kt">id</span> <span class="p">(</span><span class="o">*</span><span class="n">objc_msgSendTyped</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">id</span><span class="p">,</span> <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="p">,</span> <span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_msgSend</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">objc_msgSendTyped</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">sectionData</span><span class="p">,</span> <span class="n">parsingInfo</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>      <span class="n">oError</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">oError</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//! 4.</span>
</span><span class='line'><span class="cp">#pragma mark - Parsing sections</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nf">processActions:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">actionsArray</span> <span class="nf">parsingInfo:</span><span class="p">(</span><span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">parsingInfo</span> <span class="nf">inContext:</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="nv">context</span>  <span class="n">__used</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">__block</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">oError</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">AssertTrueOrReturnError</span><span class="p">([</span><span class="n">actionsArray</span> <span class="nl">isKindOfClass:</span><span class="n">NSArray</span><span class="p">.</span><span class="n">class</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">[</span><span class="n">actionsArray</span> <span class="nl">enumerateObjectsUsingBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">actionData</span><span class="p">,</span> <span class="n">NSUInteger</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">AssertTrueOrReturnBlock</span><span class="p">([</span><span class="n">actionData</span> <span class="nl">isKindOfClass:</span><span class="n">NSDictionary</span><span class="p">.</span><span class="n">class</span><span class="p">],</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>      <span class="n">oError</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">AssertTrueOrReturnBlock</span><span class="p">([</span><span class="n">actionData</span><span class="p">[</span><span class="s">@&quot;type&quot;</span><span class="p">]</span> <span class="nl">isKindOfClass:</span><span class="n">NSString</span><span class="p">.</span><span class="n">class</span><span class="p">],</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>      <span class="n">oError</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">SEL</span> <span class="n">selector</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">selectorForHandlingAction:</span><span class="n">actionData</span><span class="p">[</span><span class="s">@&quot;type&quot;</span><span class="p">]];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">self</span> <span class="nl">respondsToSelector:</span><span class="n">selector</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">DDLogWarn</span><span class="p">(</span><span class="s">@&quot;Ignoring json diff action %@&quot;</span><span class="p">,</span> <span class="n">actionData</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kt">id</span> <span class="p">(</span><span class="o">*</span><span class="n">objc_msgSendTyped</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="p">,</span> <span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_msgSend</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">objc_msgSendTyped</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">actionData</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>      <span class="n">oError</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">oError</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nl">processNextUrl:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">nextURL</span> <span class="nl">parsingInfo:</span><span class="p">(</span><span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">parsingInfo</span> <span class="nl">inContext:</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="n">context</span> <span class="n">__used</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">AssertTrueOrReturnError</span><span class="p">((</span><span class="kt">id</span><span class="p">)</span><span class="n">nextURL</span> <span class="o">==</span> <span class="p">[</span><span class="n">NSNull</span> <span class="n">null</span><span class="p">]</span> <span class="o">||</span> <span class="p">[</span><span class="n">nextURL</span> <span class="nl">isKindOfClass:</span><span class="n">NSString</span><span class="p">.</span><span class="n">class</span><span class="p">]);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark - Helpers</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nl">selectorForHandlingSection:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">section</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">NSSelectorFromString</span><span class="p">([</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;process%@:parsingInfo:inContext:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">section</span> <span class="n">MR_capitalizedFirstCharacterString</span><span class="p">]]);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Even though there is more code with extra methods this is easier to read and future-proofed:</p> <ol> <li>Parsing all sections is now done in a separate method.</li> <li>We now have dynamic resolution of section handling, which means we don&#8217;t hardcode supported sections, this can be very useful in the future of the project, when you need to add support for new sections, I&#8217;ll show an example later on.</li> <li>We use a typed objc_msgSend to call the selector, this is due to the fact that we need to be careful about types when working with ARC and arm64.</li> <li>The previous code has been refactored into separate methods that are called dynamically, don&#8217;t forget to use <strong>__used</strong> keyword to prevent compiler from thinking this code is dead.</li> </ol> <p>We have 2 remaining requirements:</p> <ol> <li>should ignore non implemented actions</li> <li>should create a new object for the add action</li> </ol> <p>The <em>1st</em> requirement is tested with same code as the success requirement, only using different JSON file.</p> <p>The <em>2nd</em> one is more complicated:</p> <ul> <li>we need some test classes that use our CoreData model.</li> <li>we need to make sure our CoreData is set-up correctly for testing.</li> <li>we need to finish our processActions section handling.</li> </ul> <p>Let&#8217;s start with a very basic data model:</p> <p><img src="http://merowing.info/uploads/2014/04/Model.png" width="344" height="219"></p> <p>To be able to write tests with CoreData I&#8217;d recommend using beforeEach/afterEach blocks in Kiwi, this is how they look after adding CD memory store:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>     <span class="n">__block</span> <span class="n">KZBJSONDiffParser</span> <span class="o">*</span><span class="n">sut</span><span class="p">;</span>
</span><span class='line'>      <span class="n">beforeEach</span><span class="p">(</span><span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">MagicalRecord</span> <span class="n">setupCoreDataStackWithInMemoryStore</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sut</span> <span class="o">=</span> <span class="p">[</span><span class="n">KZBJSONDiffParser</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">afterEach</span><span class="p">(</span><span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">MagicalRecord</span> <span class="n">cleanUp</span><span class="p">];</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">it</span><span class="p">(</span><span class="s">@&quot;should ignore non implemented actions&quot;</span><span class="p">,</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">__block</span> <span class="n">NSNumber</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[</span><span class="n">sut</span> <span class="nl">parseData:</span><span class="n">DataForDiffFile</span><span class="p">(</span><span class="n">newactions</span><span class="p">)</span> <span class="nl">withCompletion:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dictionary</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="nb">nil</span> <span class="o">?</span> <span class="err">@</span><span class="n">YES</span> <span class="o">:</span> <span class="err">@</span><span class="n">NO</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">[[</span><span class="n">expectFutureValue</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="n">shouldEventually</span><span class="p">]</span> <span class="n">beYes</span><span class="p">];</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">it</span><span class="p">(</span><span class="s">@&quot;should create a new object for the add action&quot;</span><span class="p">,</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">__block</span> <span class="kt">id</span> <span class="n">object</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[</span><span class="n">sut</span> <span class="nl">parseData:</span><span class="n">DataForDiffFile</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="nl">withCompletion:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dictionary</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">object</span> <span class="o">=</span> <span class="p">[</span><span class="n">KZBTextWidget</span> <span class="n">MR_findFirst</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">[[</span><span class="n">expectFutureValue</span><span class="p">(</span><span class="n">object</span><span class="p">)</span> <span class="n">shouldEventually</span><span class="p">]</span> <span class="n">beNonNil</span><span class="p">];</span>
</span><span class='line'>      <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Now we need to expand our processActions method to actually do something constructive.</p> <p>Since we added a nice flexible way for dealing with section sections, let&#8217;s replicate that for actions as well:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="kt">SEL</span> <span class="n">selector</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">selectorForHandlingAction:</span><span class="n">actionData</span><span class="p">[</span><span class="s">@&quot;type&quot;</span><span class="p">]];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">self</span> <span class="nl">respondsToSelector:</span><span class="n">selector</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">DDLogWarn</span><span class="p">(</span><span class="s">@&quot;Ignoring json diff action %@&quot;</span><span class="p">,</span> <span class="n">actionData</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">id</span> <span class="p">(</span><span class="o">*</span><span class="n">objc_msgSendTyped</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">,</span> <span class="kt">id</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_msgSend</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">objc_msgSendTyped</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">actionData</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>      <span class="n">oError</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>For the actionAdd itself, you can implement it like this:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nf">actionAdd:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">action</span> <span class="nf">inContext:</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="nv">context</span> <span class="n">__used</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">@&quot;payload&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">AssertTrueOrReturnNil</span><span class="p">([</span><span class="n">action</span> <span class="nl">isKindOfClass:</span><span class="n">NSDictionary</span><span class="p">.</span><span class="n">class</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">serverType</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">@&quot;serverType&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">AssertTrueOrReturnNil</span><span class="p">([</span><span class="n">serverType</span> <span class="nl">isKindOfClass:</span><span class="n">NSString</span><span class="p">.</span><span class="n">class</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="n">serverID</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">@&quot;serverId&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="n">AssertTrueOrReturnNil</span><span class="p">([</span><span class="n">serverID</span> <span class="nl">isKindOfClass:</span><span class="n">NSString</span><span class="p">.</span><span class="n">class</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">NSManagedObject</span> <span class="o">&lt;</span><span class="n">KZBParsableObjectProtocol</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">KZBParsingHelper</span> <span class="nl">findOrCreateWithServerType:</span><span class="n">serverType</span> <span class="nl">serverID:</span><span class="n">serverID</span> <span class="nl">inContext:</span><span class="n">context</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">obj</span> <span class="nl">updateFromDictionary:</span><span class="n">action</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <ul> <li>We are only interested in payload at this point.</li> <li>Asserts to make sure our format is matching expectations</li> <li>Only soft-errors, if we return an Error from here it will stop the whole parsing, instead I&#8217;d like to ignore incorrect data in this particular case, so I am using Asserts but not returning errors (my asserts already generate and log error info).</li> <li>findOrCreate object and ask it to update itself from the action dictionary.</li> </ul> <p>Keep in mind that in normal projects:</p> <ul> <li>I&#8217;d recommend having a separate helper for CoreData stuff.</li> <li>findOrCreate should be optimised, doing it per action is too slow when you have lots of them. It&#8217;s quite simple to optimise it but beyond scope of this article.</li> </ul> <p>This is how findOrCreate is implemented in ParsingHelper:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSManagedObject</span> <span class="o">&lt;</span><span class="n">KZBParsableObjectProtocol</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nf">findOrCreateWithServerType:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">serverType</span> <span class="nf">serverID:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">serverID</span> <span class="nf">inContext:</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="nv">context</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Class</span> <span class="n">oClass</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>  <span class="n">NSManagedObject</span> <span class="o">&lt;</span><span class="n">KZBParsableObjectProtocol</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">findWithServerType:</span><span class="n">serverType</span> <span class="nl">serverID:</span><span class="n">serverID</span> <span class="nl">inContext:</span><span class="n">context</span> <span class="nl">classForObject:</span><span class="o">&amp;</span><span class="n">oClass</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">oClass</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">oClass</span> <span class="nl">MR_createInContext:</span><span class="n">context</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">obj</span> <span class="nl">setValue:</span><span class="n">serverID</span> <span class="nl">forKey:</span><span class="p">[(</span><span class="kt">id</span><span class="p">)</span><span class="n">oClass</span> <span class="n">serverIDPropertyName</span><span class="p">]];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSManagedObject</span> <span class="o">&lt;</span><span class="n">KZBParsableObjectProtocol</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nf">findWithServerType:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">serverType</span> <span class="nf">serverID:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">serverID</span> <span class="nf">inContext:</span><span class="p">(</span><span class="n">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="nv">context</span> <span class="nf">classForObject:</span><span class="p">(</span><span class="n">out</span> <span class="n">Class</span> <span class="o">*</span><span class="p">)</span><span class="nv">oClass</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Class</span> <span class="n">classForObject</span> <span class="o">=</span> <span class="p">[</span><span class="n">KZBParsingHelper</span> <span class="nl">classForServerType:</span><span class="n">serverType</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">oClass</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="o">*</span><span class="n">oClass</span> <span class="o">=</span> <span class="n">classForObject</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">classForObject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">DDLogInfo</span><span class="p">(</span><span class="s">@&quot;Ignoring object with serverType %@ as there is no matching class&quot;</span><span class="p">,</span> <span class="n">serverType</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">AssertTrueOrReturnNilBlock</span><span class="p">([</span><span class="n">self</span> <span class="nl">checkIfClass:</span><span class="n">classForObject</span> <span class="nl">isKindOfClass:</span><span class="n">NSManagedObject</span><span class="p">.</span><span class="n">class</span><span class="p">],</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">oClass</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="o">*</span><span class="n">oClass</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="n">NSString</span> <span class="o">*</span><span class="k">const</span> <span class="n">serverIDProperty</span> <span class="o">=</span> <span class="p">[(</span><span class="kt">id</span><span class="p">)</span><span class="n">classForObject</span> <span class="n">serverIDPropertyName</span><span class="p">];</span>
</span><span class='line'>  <span class="n">NSManagedObject</span> <span class="o">&lt;</span><span class="n">KZBParsableObjectProtocol</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="n">classForObject</span> <span class="nl">MR_findFirstByAttribute:</span><span class="n">serverIDProperty</span> <span class="nl">withValue:</span><span class="n">serverID</span> <span class="nl">inContext:</span><span class="n">context</span><span class="p">];</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <ul> <li>We ignore serverTypes that don&#8217;t have a matching class</li> <li>We assert this parsable object is a managed object since this is a CoreData method.</li> <li>We try finding an existing object. If one doesn&#8217;t exist but we have found a proper class we use this class to create a new instance.</li> </ul> <p>Now all tests pass. Our architecture is finally ready to parse some data.</p> <h4>Parsing object data</h4> <p>Let&#8217;s add parsing to our ImageWidget, since we spennt some time creating a nice architecture, it&#8217;s going to be very straightforward.</p> <p>First let&#8217;s see if we can get our URL parsed correctly and transformed into an NSURL.</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">it</span><span class="p">(</span><span class="s">@&quot;should create ImageWidget with properly parsed data&quot;</span><span class="p">,</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">__block</span> <span class="n">KZBImageWidget</span> <span class="o">*</span><span class="n">imageWidget</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[</span><span class="n">sut</span> <span class="nl">parseData:</span><span class="n">DataForDiffFile</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="nl">withCompletion:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dictionary</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">imageWidget</span> <span class="o">=</span> <span class="p">[</span><span class="n">KZBImageWidget</span> <span class="n">MR_findFirst</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[[</span><span class="n">expectFutureValue</span><span class="p">(</span><span class="n">imageWidget</span><span class="p">.</span><span class="n">url</span><span class="p">)</span> <span class="n">shouldEventually</span><span class="p">]</span> <span class="nl">equal:</span><span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://goo.gl/IFSk4C&quot;</span><span class="p">]];</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>So how hard is it to add support for parsing image widgets with this architecture?</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">//! in .h</span>
</span><span class='line'><span class="k">@interface</span> <span class="nc">KZBImageWidget</span> : <span class="nc">_KZBImageWidget</span> <span class="o">&lt;</span><span class="n">KZBParsableObjectProtocol</span><span class="o">&gt;</span><span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//! in .m</span>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">KZBImageWidget</span>
</span><span class='line'>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">serverType</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="s">@&quot;ImageWidget&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">updateFromDictionary:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">dictionary</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">KZPropertyMapper</span> <span class="nl">mapValuesFrom:</span><span class="n">dictionary</span> <span class="nl">toInstance:</span><span class="n">self</span> <span class="nl">usingMapping:</span><span class="err">@</span><span class="p">{</span>
</span><span class='line'>    <span class="s">@&quot;url&quot;</span> <span class="o">:</span> <span class="n">KZBox</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">url</span><span class="p">),</span>
</span><span class='line'>    <span class="s">@&quot;caption&quot;</span> <span class="o">:</span> <span class="n">KZProperty</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>And that&#8217;s it. Pretty simple isn&#8217;t it? You just conform to the protocol, specify the class and describe the mapping.</p> <h4>Yeah right</h4> <p>That was really simple data, what if I&#8217;d like to have a CoreData relationship? It&#8217;s probably going to be <em>dreadful and hard</em>?</p> <p><strong>Not really</strong>.</p> <p>Let&#8217;s say our server architecture changes and we need to add a relationship between ImageWidget and TextWidget:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;serverId&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;serverType&quot;</span><span class="p">:</span> <span class="s2">&quot;ImageWidget&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://goo.gl/IFSk4C&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;caption&quot;</span> <span class="p">:</span> <span class="s2">&quot;it works!&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="nt">&quot;textWidgetId&quot;</span> <span class="p">:</span> <span class="s2">&quot;0&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>How can we change our parsing to handle this? 2 Options:</p> <ol> <li>Add boxing in a category to be able to create objects like that, preferable if you need to repeat this kind of mapping in multiple places.</li> <li>Just use KZCall to create sub-object:</li> </ol> <p>First let&#8217;s add test for our new requirement:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">it</span><span class="p">(</span><span class="s">@&quot;should create ImageWidget with properly parsed relationship&quot;</span><span class="p">,</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">__block</span> <span class="kt">BOOL</span> <span class="n">isEqual</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[</span><span class="n">sut</span> <span class="nl">parseData:</span><span class="n">DataForDiffFile</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="nl">withCompletion:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dictionary</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">KZBImageWidget</span> <span class="o">*</span><span class="n">imageWidget</span> <span class="o">=</span> <span class="p">[</span><span class="n">KZBImageWidget</span> <span class="n">MR_findFirst</span><span class="p">];</span>
</span><span class='line'>    <span class="n">KZBTextWidget</span> <span class="o">*</span><span class="n">textWidget</span> <span class="o">=</span> <span class="p">[</span><span class="n">KZBTextWidget</span> <span class="n">MR_findFirst</span><span class="p">];</span>
</span><span class='line'>    <span class="n">isEqual</span> <span class="o">=</span> <span class="n">imageWidget</span> <span class="o">&amp;&amp;</span> <span class="n">imageWidget</span><span class="p">.</span><span class="n">textWidget</span> <span class="o">==</span> <span class="n">textWidget</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[[</span><span class="n">expectFutureValue</span><span class="p">(</span><span class="err">@</span><span class="p">(</span><span class="n">isEqual</span><span class="p">))</span> <span class="n">shouldEventually</span><span class="p">]</span> <span class="n">beTrue</span><span class="p">];</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Now we need to update our KZBImageWidget parsing like this:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">updateFromDictionary:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">dictionary</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">[</span><span class="n">KZPropertyMapper</span> <span class="nl">mapValuesFrom:</span><span class="n">dictionary</span> <span class="nl">toInstance:</span><span class="n">self</span> <span class="nl">usingMapping:</span><span class="err">@</span><span class="p">{</span>
</span><span class='line'>    <span class="s">@&quot;url&quot;</span> <span class="o">:</span> <span class="n">KZBox</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">url</span><span class="p">),</span>
</span><span class='line'>    <span class="s">@&quot;caption&quot;</span> <span class="o">:</span> <span class="n">KZProperty</span><span class="p">(</span><span class="n">caption</span><span class="p">),</span>
</span><span class='line'>    <span class="s">@&quot;textWidgetId&quot;</span> <span class="o">:</span> <span class="n">KZCall</span><span class="p">(</span><span class="nl">objectForId:</span><span class="p">,</span> <span class="n">textWidget</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">objectForId:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">serverID</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">AssertTrueOrReturnNil</span><span class="p">([</span><span class="n">serverID</span> <span class="nl">isKindOfClass:</span><span class="n">NSString</span><span class="p">.</span><span class="n">class</span><span class="p">]);</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">[</span><span class="n">KZBParsingHelper</span> <span class="nl">findWithServerType:</span><span class="p">[</span><span class="n">KZBWidget</span> <span class="n">serverType</span><span class="p">]</span> <span class="nl">serverID:</span><span class="n">serverID</span> <span class="nl">inContext:</span><span class="n">self</span><span class="p">.</span><span class="n">managedObjectContext</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Looks simple enough?</p> <ol> <li>Use KZCall to specify the selector to be called with textWidgetId value, the resulting value should be assigned to the textWidget property.</li> <li>objectForId method that will query ANY subclass of KZBWidget that has specific serverID.</li> </ol> <p>I&#8217;ve implemented objectForId without textWidgetType because you could move this code to KZPropertyMapper as a new boxing and have it used in ALL your relationships if needed.</p> <p>KZPM offers more than we used here:</p> <ul> <li>It does compile time checking for your property / method names</li> <li>Allows extra simple expansion by using categories</li> <li>Offers simple validation logic with a custom DSL syntax</li> </ul> <p><a href="https://github.com/krzysztofzablocki/KZPropertyMapper">Read more at it&#8217;s github page.</a></p> <h1>Conclusion and what&#8217;s next?</h1> <p>So now we have fetching capabilities and parsing, how do we connect the two ?</p> <p>In the next part of this series I&#8217;ll introduce a DataService class(for lack of better name) that coordinates Provider and Parser using composition, it has some simple features like auto-updating, following URL redirections(nextURL) etc.</p> <p>I&#8217;ll also start connecting our data to UI, so you&#8217;ll be able to see how we can use CoreData to drive our responsive UI with little fuss.</p> <p><a href="https://github.com/krzysztofzablocki/KZBootstrap">Grab source code from GitHub</a></p> <p>This was a long article and I really hope you found it at least mildly interesting, <a href="http://twitter.com/merowing_">send me a tweet</a></p> <h4>Foot notes</h4> <ul> <li>In normal projects you should definitely have more tests and they could be refactored a little bit.</li> <li>This is the general idea, but it&#8217;s a good start, I&#8217;d adapt it to project specific needs.</li> </ul> </div> </article> <div class="share"> <div class="addthis_sharing_toolbox"></div> <script type="text/javascript">
var addthis_share = addthis_share || {}
addthis_share = {
passthrough : {
twitter: {
via: "merowing_",
text: "Great article"
}
}
}
</script> <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script> <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-532368630eb37492" async></script> </div> </div> </div> <footer id="footer" class="inner">Copyright &copy; 2015 Krzysztof Zabłocki Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer> <script src="/javascripts/slash.js"></script> <script src="/javascripts/code-toggle.js"></script> <script src="/javascripts/jquery.fancybox.pack.js"></script> <script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-29400340-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();

		$('a').click(function() { 
			var $a = $(this); var href = $a.attr('href');
			// see if the link is external 
			if ( (href.match(/^http/)) && (! href.match(document.domain)) ) {

			// if so, register an event
			var category = 'outgoing'; // set this to whatever you want
			var event = 'click'; // set this to whatever you want
			var label = href; // set this to whatever you want
			pageTracker._trackEvent(category, event, href);
			}});
	</script> </div> </div> </body> </html>