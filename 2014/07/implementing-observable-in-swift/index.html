<!DOCTYPE HTML> <html> <head> <meta charset="utf-8"> <title>Implementing Observable in Swift - Krzysztof Zabłocki</title> <meta name="author" content="Krzysztof Zabłocki"> <meta name=”twitter:site” content=”@merowing_> <meta name="description" content="Implementing Observable in Swift Use it or not, KVO has been integral part of Cocoa programming, yet if you decide to use only native Swift code you &hellip;"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link href="/atom.xml" rel="alternate" title="Krzysztof Zabłocki" type="application/atom+xml"> <link rel="canonical" href="http://krzysztofzablocki.github.com/krzysztofzablocki/2014/07/implementing-observable-in-swift"> <link href="/favicon.png" rel="shortcut icon"> <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css"> <link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script> <style type="text/css">
  .fancybox-wrap { position: fixed !important; }
  .fancybox-opened {
    -webkit-border-radius: 4px !important;
       -moz-border-radius: 4px !important;
            border-radius: 4px !important;
  }
  .fancybox-close, .fancybox-prev span, .fancybox-next span {
    background-color: transparent !important;
    border: 0 !important;
  }
</style> <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-29400340-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();

		$('a').click(function() { 
			var $a = $(this); var href = $a.attr('href');
			// see if the link is external 
			if ( (href.match(/^http/)) && (! href.match(document.domain)) ) {

			// if so, register an event
			var category = 'outgoing'; // set this to whatever you want
			var event = 'click'; // set this to whatever you want
			var label = href; // set this to whatever you want
			pageTracker._trackEvent(category, event, href);
			}});
	</script> </head> <body> <div class="container"> <div class="left-col"> <div class="intrude-less"> <header id="header" class="inner"><div class="profilepic"> <script src="/javascripts/md5.js"></script> <script type="text/javascript">
		$(function(){
			$('.profilepic').append("<a href='http://twitter.com/merowing_'><img src='http://www.gravatar.com/avatar/" + MD5("krzysztof.zablocki@pixle.pl") + "?s=120' alt='Profile Picture' style='width: 120px; float: left; margin: 0px 15px 15px 0px;' /></a> <div class='header_bio'><a href='/about/''>Krzysztof Zabłocki - Software Engineer.</a></div>");
		});
	</script> </div> <nav id="main-nav"><ul class="main"> <br/> <br/> <div class="indie_apps" style="clear:both;"> <a href="http://appstore.com/foldify"><img class="app_poster" src="http://www.merowing.info/images/foldify.png" alt="Foldify"></a> <a href="http://appstore.com/foldifyzoo"><img class="app_poster" src="http://www.merowing.info/images/foldifyzoo.png" alt="Foldify Zoo"></a> <a href="https://itunes.apple.com/us/app/storest-kids-love-playing/id926102013?mt=8"><img class="app_poster" src="http://www.merowing.info/images/storest.png" alt="Bord"></a> <a href="http://appstore.com/bord"><img class="app_poster" src="http://www.merowing.info/images/bord.png" alt="Storest"></a> <br/> <br/> </div> <li><a href="/about">About me</a></li> <li><a href="/speaking">Speaking</a></li> <li><a href="/">Blog</a></li> <li><a href="/blog/archives">Archives</a></li> </ul> </nav> <nav id="popular"> <section> <h4>Recommended</h4> <li class="related"><a href="/2014/10/how-do-i-work/">How do I Work?</a></li> <li class="related"><a href="/2014/03/refactoring-tricks">Refactoring tricks</a> and <a href="/2014/02/ios-developer-tools">Developer Tools</a></li> <li class="related"><a href="/2012/04/drawing-smooth-lines-with-cocos2d-ios-inspired-by-paper">Drawing smooth lines</a></li> <li class="related"><a href="https://github.com/krzysztofzablocki/KZPropertyMapper">Data Parsing</a> and <a href="https://github.com/krzysztofzablocki/KZBootstrap">Project bootstrap</a></li> </section> </nav> <nav id="sub-nav"> <div class="social"> <a class="email" href="mailto:krzysztof.zablocki@pixle.pl" title="Email">Email</a> <a class="facebook" href="http://www.facebook.com/100000315956630" title="Facebook">Facebook</a> <a class="twitter" href="http://twitter.com/merowing_" title="Twitter">Twitter</a> <a class="github" href="https://github.com/krzysztofzablocki" title="GitHub">GitHub</a> <a class="linkedin" href="http://www.linkedin.com/profile/view?id=90077810" title="LinkedIn">LinkedIn</a> <a class="rss" href="/atom.xml" title="RSS">RSS</a> </div> </nav></header> </div> </div> <div class="mid-col"> <div class="mid-col-container"> <div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <h1 class="title" itemprop="name">Implementing Observable in Swift</h1> <div class="entry-content" itemprop="articleBody"><p>Use it or not, KVO has been integral part of Cocoa programming, yet if you decide to use only native Swift code you are loosing ability to observe other object properties.</p> <p>There is a way to add Observable properties back to your own codebase with generics in a way they won’t have ripple effect on remaining code, it’s actually pretty cool.</p> <h2>API Design</h2> <p>When I thought of how I want to implement Observable properties, I’ve had few things in mind:</p> <ol> <li>Distinct closures for Will/Did set.</li> <li>Ability to access current value and old/new one.</li> <li>Observable property should work as non-observable one, if function takes int as argument it should work with both cases.</li> </ol> <p>1 and 2 can be satisfied with just API design, sample code for usage of Observable looks like this:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">object</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(.</span><span class="n">WillSet</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">println</span><span class="p">(</span><span class="s">&quot;Will set value to \($0) curValue \($1)”)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>What I meant by point 3 is best explained with some sample code. Let’s say we have a class Foo in our Library/Module:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">struct</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">rawInt</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">observableInt</span> <span class="o">=</span> <span class="n">Observable</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Let’s say user of our library has a function that processes ints:</p> <div> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">func</span> <span class="n">processInt</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> </div> <p></p> <p>Now I want the users of my module to be able to just use my code, regardless of it beining observable or not:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">let</span> <span class="n">object</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
</span><span class='line'><span class="n">processInt</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="n">rawInt</span><span class="p">)</span>
</span><span class='line'><span class="n">processInt</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="n">observableInt</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Having a code like this would mean that you as an user of my code doesn’t need to care if it’s observable or not, yet you could leverage that power if you needed/wanted.</p> <h2>Swift Types and Implict conversions</h2> <p>Implementing compliance with above requirement (3rd) wouldn’t be possible in Swift because of Type difference if not for a little known function called <strong>__conversion()</strong>, conversion as the name clearly states gives you implicit conversion between types, this is how we can use it for our Observable properties:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">struct</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">raw</span> <span class="o">:</span> <span class="n">T</span>
</span><span class='line'><span class="c1">// other code...</span>
</span><span class='line'>  <span class="n">func</span> <span class="n">__conversion</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">T</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">raw</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Now each time a parameter of T is required, we can use Observable<T> instead.</p> <h2>Swift issues and Wish-list</h2> <p>When I was playing with the idea of Observables I’ve found few things that either crashed the compiler (<em>Ouch</em>) or just didn’t work in language (yet?).</p> <p>Issues:</p> <ul> <li>Putting enum declaration in a generic Struct will kill your Xcode -> that’s why ObservingType is separate enum.</li> <li>Working with compound collections (Hash of Arrays) has some really weird behaviours: <ul> <li>don’t try using mapping with observingInfo or compiler crashes -> thus let instead of simple map</li> <li>Can’t do inline manipulation of Arrays in hash -> needed to overwrite whole array object in a hash</li> </ul> </li> </ul> <p>Wish list:</p> <ol> <li>Would be nice to have a way to define behaviour/mutability for compound collections</li> <li>Ability to create extensions from a generic scope or overload assigment = operator, right now to be able to modify Observable<T> we need to use rawValue accessor which is far from perfect.</li> </ol> <p>Hopefully Apple is working on at least some of those points.</p> <p><a href="https://github.com/krzysztofzablocki/Swift-Observable">Full playground is available here</a></p> <p>If you’d like to chat <a href="http://twitter.com/merowing_">send me a tweet</a> or even better send me some PR’s :-)</p> </div> </article> <div class="share"> <div class="addthis_sharing_toolbox"></div> <script type="text/javascript">
var addthis_share = addthis_share || {}
addthis_share = {
passthrough : {
twitter: {
via: "merowing_",
text: "Great article"
}
}
}
</script> <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script> <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-532368630eb37492" async></script> </div> </div> </div> <footer id="footer" class="inner">Copyright &copy; 2015 Krzysztof Zabłocki Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer> <script src="/javascripts/slash.js"></script> <script src="/javascripts/code-toggle.js"></script> <script src="/javascripts/jquery.fancybox.pack.js"></script> <script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-29400340-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();

		$('a').click(function() { 
			var $a = $(this); var href = $a.attr('href');
			// see if the link is external 
			if ( (href.match(/^http/)) && (! href.match(document.domain)) ) {

			// if so, register an event
			var category = 'outgoing'; // set this to whatever you want
			var event = 'click'; // set this to whatever you want
			var label = href; // set this to whatever you want
			pageTracker._trackEvent(category, event, href);
			}});
	</script> </div> </div> </body> </html>