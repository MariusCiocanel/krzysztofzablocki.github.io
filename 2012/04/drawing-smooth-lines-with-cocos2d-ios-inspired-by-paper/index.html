<!DOCTYPE HTML> <html> <head> <meta charset="utf-8"> <title>Drawing smooth lines with cocos2d - Krzysztof Zabłocki</title> <meta name="author" content="Krzysztof Zabłocki"> <meta name=”twitter:site” content=”@merowing_> <meta name="description" content="Drawing smooth lines with cocos2d You’ve probably seen Paper by http://www.fiftythree.com/, the app is pretty cool and the drawings look really nice &hellip;"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link href="/atom.xml" rel="alternate" title="Krzysztof Zabłocki" type="application/atom+xml"> <link rel="canonical" href="http://krzysztofzablocki.github.com/krzysztofzablocki/2012/04/drawing-smooth-lines-with-cocos2d-ios-inspired-by-paper"> <link href="/favicon.png" rel="shortcut icon"> <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css"> <link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css"> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script> <style type="text/css">
  .fancybox-wrap { position: fixed !important; }
  .fancybox-opened {
    -webkit-border-radius: 4px !important;
       -moz-border-radius: 4px !important;
            border-radius: 4px !important;
  }
  .fancybox-close, .fancybox-prev span, .fancybox-next span {
    background-color: transparent !important;
    border: 0 !important;
  }
</style> <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-29400340-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();

		$('a').click(function() { 
			var $a = $(this); var href = $a.attr('href');
			// see if the link is external 
			if ( (href.match(/^http/)) && (! href.match(document.domain)) ) {

			// if so, register an event
			var category = 'outgoing'; // set this to whatever you want
			var event = 'click'; // set this to whatever you want
			var label = href; // set this to whatever you want
			pageTracker._trackEvent(category, event, href);
			}});
	</script> </head> <body> <div class="container"> <div class="left-col"> <div class="intrude-less"> <header id="header" class="inner"><div class="profilepic"> <script src="/javascripts/md5.js"></script> <script type="text/javascript">
		$(function(){
			$('.profilepic').append("<a href='http://twitter.com/merowing_'><img src='http://www.gravatar.com/avatar/" + MD5("krzysztof.zablocki@pixle.pl") + "?s=120' alt='Profile Picture' style='width: 120px; float: left; margin: 0px 15px 15px 0px;' /></a> <div class='header_bio'><a href='/about/''>Krzysztof Zabłocki - Software Engineer.</a></div>");
		});
	</script> </div> <nav id="main-nav"><ul class="main"> <br/> <br/> <div class="indie_apps" style="clear:both;"> <a href="http://appstore.com/foldify"><img class="app_poster" src="http://www.merowing.info/images/foldify.png" alt="Foldify"></a> <a href="http://appstore.com/foldifyzoo"><img class="app_poster" src="http://www.merowing.info/images/foldifyzoo.png" alt="Foldify Zoo"></a> <a href="http://appstore.com/foldifydino"><img class="app_poster" src="http://www.merowing.info/images/foldifydino.png" alt="Foldify Dino"></a> <a href="https://itunes.apple.com/us/app/storest-kids-love-playing/id926102013?mt=8"><img class="app_poster" src="http://www.merowing.info/images/storest.png" alt="Bord"></a> <a href="http://appstore.com/bord"><img class="app_poster" src="http://www.merowing.info/images/bord.png" alt="Storest"></a> <br/> <br/> </div> <li><a href="/about">About me</a></li> <li><a href="/speaking">Speaking</a></li> <li><a href="/">Blog</a></li> <li><a href="/blog/archives">Archives</a></li> </ul> </nav> <nav id="popular"> <section> <h4>Recommended</h4> <li class="related"><a href="/2014/10/how-do-i-work/">How do I Work?</a></li> <li class="related"><a href="/2014/03/refactoring-tricks">Refactoring tricks</a> and <a href="/2014/02/ios-developer-tools">Developer Tools</a></li> <li class="related"><a href="/2012/04/drawing-smooth-lines-with-cocos2d-ios-inspired-by-paper">Drawing smooth lines</a></li> <li class="related"><a href="https://github.com/krzysztofzablocki/KZPropertyMapper">Data Parsing</a> and <a href="https://github.com/krzysztofzablocki/KZBootstrap">Project bootstrap</a></li> </section> </nav> <nav id="sub-nav"> <div class="social"> <a class="email" href="mailto:krzysztof.zablocki@pixle.pl" title="Email">Email</a> <a class="facebook" href="http://www.facebook.com/100000315956630" title="Facebook">Facebook</a> <a class="twitter" href="http://twitter.com/merowing_" title="Twitter">Twitter</a> <a class="github" href="https://github.com/krzysztofzablocki" title="GitHub">GitHub</a> <a class="linkedin" href="http://www.linkedin.com/profile/view?id=90077810" title="LinkedIn">LinkedIn</a> <a class="rss" href="/atom.xml" title="RSS">RSS</a> </div> </nav></header> </div> </div> <div class="mid-col"> <div class="mid-col-container"> <div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <h1 class="title" itemprop="name">Drawing smooth lines with cocos2d</h1> <div class="entry-content" itemprop="articleBody"><p>You’ve probably seen <a href="http://www.fiftythree.com/">Paper by http://www.fiftythree.com/</a>, the app is pretty cool and the drawings look really nice and smooth. I’m working on my personal app that needs something similar, and after doing some research I’ve seen that there isn’t really anything like that available, some people try to use catmull roms etc. but that doesn’t look good enough. I will show you how you can achieve pretty cool drawing app.</p> <h2>Analyzing</h2> <p>If you play with first Paper tool, you will notice few key points that we need to duplicate:</p> <ol> <li>Even if you draw fast, the lines will be bend by some kind of splines.</li> <li>Lines width is depended on the speed of touches.</li> <li>Lines are very smooth, no hard edges are visible.</li> </ol> <p>I will explain my solution in a few steps that allow you to go from this: <img src="http://www.merowing.info/uploads/2012/04/Step_1.png" width="320" height="240"> to this: <img src="http://www.merowing.info/uploads/2012/04/Step_4.png" width="320" height="240"></p> <p>Look at the images in full resolution to really see how big the difference is…</p> <p>Let’s get to work.</p> <h2>Connecting the dots</h2> <p>To draw anything we first need to collect touches positions for drawing. I’ve used UIPanGestureRecognizer to collect them, to have them working with cocos2d I just included <a href="https://github.com/krzysztofzablocki/CCNode-SFGestureRecognizers">my category</a>. After you have some points we need to render them, and since we will be needing line segments that can start at arbitrary width and end at totally different one, we need to make our own rendering. To render the lines with variable width at both ends of a single line segment we need to draw them by using triangles, this is how we can do that:</p> <p><img src="http://www.merowing.info/uploads/2012/04/figure_1.png" width="320" height="240"></p> <p>As you can see here:</p> <ul> <li>p0, p1 are the line segment begin / end points.</li> <li>perp is perpendicular to segment direction ( -y, x of direction ), if we normalize it we can use it to create ABCD coordinates, simply by multiplying it by our desired width and either adding or subtracting from our base points p0, p1</li> <li>ABC, BCD will be our triangles.</li> <li>both line start and end can have arbitrary width.</li> </ul> <p>We need to calculate ABCD coordinates, we have p0, p1 and start width and end width. In code we do this as follows:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">CGPoint</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">ccpSub</span><span class="p">(</span><span class="n">curPoint</span><span class="p">,</span> <span class="n">prevPoint</span><span class="p">);</span>
</span><span class='line'><span class="n">CGPoint</span> <span class="n">perpendicular</span> <span class="o">=</span> <span class="n">ccpNormalize</span><span class="p">(</span><span class="n">ccpPerp</span><span class="p">(</span><span class="n">dir</span><span class="p">));</span>
</span><span class='line'><span class="n">CGPoint</span> <span class="n">A</span> <span class="o">=</span> <span class="n">ccpAdd</span><span class="p">(</span><span class="n">prevPoint</span><span class="p">,</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">perpendicular</span><span class="p">,</span> <span class="n">prevValue</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
</span><span class='line'><span class="n">CGPoint</span> <span class="n">B</span> <span class="o">=</span> <span class="n">ccpSub</span><span class="p">(</span><span class="n">prevPoint</span><span class="p">,</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">perpendicular</span><span class="p">,</span> <span class="n">prevValue</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
</span><span class='line'><span class="n">CGPoint</span> <span class="n">C</span> <span class="o">=</span> <span class="n">ccpAdd</span><span class="p">(</span><span class="n">curPoint</span><span class="p">,</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">perpendicular</span><span class="p">,</span> <span class="n">curValue</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
</span><span class='line'><span class="n">CGPoint</span> <span class="n">D</span> <span class="o">=</span> <span class="n">ccpSub</span><span class="p">(</span><span class="n">curPoint</span><span class="p">,</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">perpendicular</span><span class="p">,</span> <span class="n">curValue</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure> </div> <ol> <li>Calculate direction from p0 ( prevPoint ) to p1 ( curPoint )</li> <li>Calculate perpendicular vector and normalize it.</li> <li>Use perpendicular multiplied by line width to get coordinates for ABCD.</li> <li>prevValue / curValue are the widths of line segment start / end points.</li> </ol> <p>Then you go through all the points you have and calculate each line segment.</p> <p>But there is something more you need to do, if you would just calculate each of this vertices per segment, you would end up with disconnected segments:</p> <p><img src="http://www.merowing.info/uploads/2012/04/figure_2.png" width="320" height="240"></p> <p>We don’t want that. To make it work let’s make each line C, D vertices the A, B vertices of the next segment, that way we will have proper connection’s between segments, generating full line.</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">connectingLine</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">A</span> <span class="o">=</span> <span class="n">prevC</span><span class="p">;</span>
</span><span class='line'>      <span class="n">B</span> <span class="o">=</span> <span class="n">prevD</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>Since we will need to store position and size in each point, we introduce new class for that:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">LinePoint</span> : <span class="nc">NSObject</span>
</span><span class='line'><span class="k">@property</span><span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="n">CGPoint</span> <span class="n">pos</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span><span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="kt">float</span> <span class="n">width</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure> </div> <h3>Performance note</h3> <p>Since the user can draw as many lines as he want and they can be of arbitrary length, if we would draw them in each frame that would very quickly become performance problem. There is a simple solution for that i.e. draw each line segment we get into a texture, that way it doesn’t really matter how many lines user draws or how long they will be. At this point we would just get straight lines connecting our points:</p> <p><img src="http://www.merowing.info/uploads/2012/04/Step_1.png" width="320" height="240"></p> <p>Nothing impressive, but this is just the first step…</p> <h2>Calculating width based on speed of panning</h2> <p>We need to have slim lines when the user is panning slowly and fat lines if he is moving very quickly, we can use UIPanGestureRecognizer <strong>velocityInView</strong>: method to recognize that:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="nf">extractSize:</span><span class="p">(</span><span class="n">UIPanGestureRecognizer</span> <span class="o">*</span><span class="p">)</span><span class="nv">panGestureRecognizer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="c1">// 1</span>
</span><span class='line'>  <span class="kt">float</span> <span class="n">vel</span> <span class="o">=</span> <span class="n">ccpLength</span><span class="p">([</span><span class="n">panGestureRecognizer</span> <span class="nl">velocityInView:</span><span class="n">panGestureRecognizer</span><span class="p">.</span><span class="n">view</span><span class="p">]);</span>
</span><span class='line'>  <span class="kt">float</span> <span class="n">size</span> <span class="o">=</span> <span class="n">vel</span> <span class="o">/</span> <span class="mf">166.0f</span><span class="p">;</span>
</span><span class='line'>  <span class="n">size</span> <span class="o">=</span> <span class="n">clampf</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">([</span><span class="n">velocities</span> <span class="n">count</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mf">0.2f</span> <span class="o">%</span><span class="mi">2</span><span class="n">B</span> <span class="p">[[</span><span class="n">velocities</span> <span class="nl">objectAtIndex:</span><span class="p">[</span><span class="n">velocities</span> <span class="n">count</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="n">floatValue</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.8f</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="p">[</span><span class="n">velocities</span> <span class="nl">addObject:</span><span class="p">[</span><span class="n">NSNumber</span> <span class="nl">numberWithFloat:</span><span class="n">size</span><span class="p">]];</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p></p> <ol> <li>We calculate length of velocity vector, then we adjust the value to fit between 1 and 40 pixels.</li> <li>By weighting new velocity value we will make nicer transition between sizes, instead of jumpy ones…</li> </ol> <p>Remember that this function was result of trial &amp; error, so feel free and play around with it if you wan’t…</p> <h2>Bending the lines</h2> <p>Research in the internet would suggest to use Catmull-rom algorithm for drawing smooth lines that we want. This splines are one of few splines that go through all control points you specify, it’s really good algorithm for some cases e.g. interpolating Camera position for cutscenes. <strong>But for drawing I don’t believe that to be best solution</strong> because for me it has 2 major caveats:</p> <ul> <li>You need to simplify point’s list, so that points are not too close to each other or the algorithm won’t really yield good results.</li> <li>This algorithm works nice if you have a final set of control points, in case of drawing app you don’t have that, points will be added after user moves his finger, and we need to draw new lines immediately.</li> </ul> <p>So contrary to what you can find in google, I decided to <strong>not</strong> use Catmull-rom for drawing app…</p> <p>Quad curves require 3 points to calculate, we will be using our original touch points as control points and the start / end coordinates will be calculated as the point in the middle between our control points:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSMutableArray</span> <span class="o">*</span><span class="p">)</span><span class="nf">calculateSmoothLinePoints</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="c1">// 1</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">([</span><span class="n">points</span> <span class="n">count</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">smoothedPoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">[</span><span class="n">points</span> <span class="n">count</span><span class="p">];</span> <span class="o">%</span><span class="mi">2</span><span class="n">B</span><span class="o">%</span><span class="mi">2</span><span class="n">Bi</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">LinePoint</span> <span class="o">*</span><span class="n">prev2</span> <span class="o">=</span> <span class="p">[</span><span class="n">points</span> <span class="nl">objectAtIndex:</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
</span><span class='line'>      <span class="n">LinePoint</span> <span class="o">*</span><span class="n">prev1</span> <span class="o">=</span> <span class="p">[</span><span class="n">points</span> <span class="nl">objectAtIndex:</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>      <span class="n">LinePoint</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="p">[</span><span class="n">points</span> <span class="nl">objectAtIndex:</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'>      <span class="n">CGPoint</span> <span class="n">midPoint1</span> <span class="o">=</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">ccpAdd</span><span class="p">(</span><span class="n">prev1</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">prev2</span><span class="p">.</span><span class="n">pos</span><span class="p">),</span> <span class="mf">0.5f</span><span class="p">);</span>
</span><span class='line'>      <span class="n">CGPoint</span> <span class="n">midPoint2</span> <span class="o">=</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">ccpAdd</span><span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">prev1</span><span class="p">.</span><span class="n">pos</span><span class="p">),</span> <span class="mf">0.5f</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 4</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">segmentDistance</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">ccpDistance</span><span class="p">(</span><span class="n">midPoint1</span><span class="p">,</span> <span class="n">midPoint2</span><span class="p">);</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">numberOfSegments</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">MAX</span><span class="p">(</span><span class="n">floorf</span><span class="p">(</span><span class="n">distance</span> <span class="o">/</span> <span class="n">segmentDistance</span><span class="p">),</span> <span class="mi">32</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 5</span>
</span><span class='line'>      <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">float</span> <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">/</span> <span class="n">numberOfSegments</span><span class="p">;</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">NSUInteger</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numberOfSegments</span><span class="p">;</span> <span class="n">j</span><span class="o">%</span><span class="mi">2</span><span class="n">B</span><span class="o">%</span><span class="mi">2</span><span class="n">B</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">LinePoint</span> <span class="o">*</span><span class="n">newPoint</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LinePoint</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="c1">// 6</span>
</span><span class='line'>        <span class="n">newPoint</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">ccpAdd</span><span class="p">(</span><span class="n">ccpAdd</span><span class="p">(</span><span class="n">ccpMult</span><span class="p">(</span><span class="n">midPoint1</span><span class="p">,</span> <span class="n">powf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">prev1</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="mf">2.0f</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)),</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">midPoint2</span><span class="p">,</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span><span class="p">));</span>
</span><span class='line'>        <span class="n">newPoint</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">powf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">prev1</span><span class="p">.</span><span class="n">width</span> <span class="o">%</span><span class="mi">2</span><span class="n">B</span> <span class="n">prev2</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5f</span><span class="p">)</span> <span class="o">%</span><span class="mi">2</span><span class="n">B</span> <span class="mf">2.0f</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">prev1</span><span class="p">.</span><span class="n">width</span> <span class="o">%</span><span class="mi">2</span><span class="n">B</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="p">((</span><span class="n">cur</span><span class="p">.</span><span class="n">width</span> <span class="o">%</span><span class="mi">2</span><span class="n">B</span> <span class="n">prev1</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5f</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">[</span><span class="n">smoothedPoints</span> <span class="nl">addObject:</span><span class="n">newPoint</span><span class="p">];</span>
</span><span class='line'>        <span class="n">t</span> <span class="o">%</span><span class="mi">2</span><span class="n">B</span><span class="o">=</span> <span class="n">step</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="c1">// 7</span>
</span><span class='line'>      <span class="n">LinePoint</span> <span class="o">*</span><span class="n">finalPoint</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LinePoint</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>      <span class="n">finalPoint</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">midPoint2</span><span class="p">;</span>
</span><span class='line'>      <span class="n">finalPoint</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">width</span> <span class="o">%</span><span class="mi">2</span><span class="n">B</span> <span class="n">prev1</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5f</span><span class="p">;</span>
</span><span class='line'>      <span class="p">[</span><span class="n">smoothedPoints</span> <span class="nl">addObject:</span><span class="n">finalPoint</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="c1">// 8</span>
</span><span class='line'>    <span class="p">[</span><span class="n">points</span> <span class="nl">removeObjectsInRange:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">points</span> <span class="n">count</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)];</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">smoothedPoints</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p></p> <ol> <li>We need at least 3 points to use quad curves.</li> <li>Each time we need our current point and 2 previous ones.</li> <li>Calculate our middle points between touch points.</li> <li>Calculate number of segments, for each 2 pixels there will be one extra segment, minimum of 32 segments and maximum of 128. If 2 mid points would be 100 pixels apart we would have 50 segments, we need to make sure we have at least 32 segments or the bending will look aliased…</li> <li>Calculate our interpolation t increase based on the number of segments.</li> <li>Calculate our new points by using quad curve equation. Also use same interpolation for line width.</li> <li>Add final point connecting to our end point</li> <li>Since we will be drawing right after this function, we don’t need old points except the last 2. That way each time user moves his finger we can draw next segment.</li> </ol> <p>Now we use this smoothed points for drawing, exactly as we did with the old ones… At this point the app generates something like this:</p> <p><img src="http://www.merowing.info/uploads/2012/04/Step_3.png" width="320" height="240"></p> <p>It start’s to look interesting, the lines are bending pretty nice ( we could play around with number of segments we used to smooth our lines to get even more quality ). There is quite a bit of aliasing visible here that doesn’t look nice, and also the start / end point of line don’t look nice…</p> <h2>Anti-Aliasing lines</h2> <p>Aliasing is pretty common problem in computer graphics, usually you could just use hardware Multisampling, cocos also supports that ( just set proper flags in CCGLView creation ). But this is overkill for our drawing, if we would enable multisampling here, not only we would get performance hit but that way we would also make rest of the app use multisampling… There is a lot simpler solution… Aliasing is so visible because we go from full color straight to an empty one ( black to white ) in an instant. So <strong>let’s not do that</strong>, let’s make the color linearly interpolate from full color to an empty one. We just need to modify alpha value from 1 to 0 over some range of pixels and hardware blending will do the rest for us… Let’s create additional triangles at the edges of our line and modify alpha there:</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">CGPoint</span> <span class="n">F</span> <span class="o">=</span> <span class="n">ccpAdd</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">perpendicular</span><span class="p">,</span> <span class="n">overdraw</span><span class="p">));</span>
</span><span class='line'><span class="n">CGPoint</span> <span class="n">G</span> <span class="o">=</span> <span class="n">ccpAdd</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">perpendicular</span><span class="p">,</span> <span class="n">overdraw</span><span class="p">));</span>
</span><span class='line'><span class="n">CGPoint</span> <span class="n">H</span> <span class="o">=</span> <span class="n">ccpSub</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">perpendicular</span><span class="p">,</span> <span class="n">overdraw</span><span class="p">));</span>
</span><span class='line'><span class="n">CGPoint</span> <span class="n">I</span> <span class="o">=</span> <span class="n">ccpSub</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">ccpMult</span><span class="p">(</span><span class="n">perpendicular</span><span class="p">,</span> <span class="n">overdraw</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>So we just expand even further from our fat line by the amount of overdraw we want, this vertices will have alpha value = 0 so that linear interpolation occur. Then from this vertices we generate 4 overdraw triangles: FAG, AGC, BHD, HDI Since lines can be drawn over each other, we need to make sure our overdraw doesn’t render over full lines, or we would get artifacts… To get correct blending between overdraw / full lines I decided to use GL_ONE, GL_ONE_MINUS_SRC_ALPHA, use pre-multiplied blending (read why it’s better to use it here: http://blogs.msdn.com/b/shawnhar/archive/2009/11/06/premultiplied-alpha.aspx ):</p> <div> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">glBlend</span><span class="p">(</span><span class="n">GL_ONE</span><span class="p">,</span> <span class="n">GL_ONE_MINUS_SRC_ALPHA</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure> </div> <p></p> <h2>Final touches</h2> <p>Last thing we need to do is make sure our start / end line points are circular and smooth instead of hard cut off. But we can’t draw full circles at end points or the overdraw alpha would add up and it would look weird, instead we will draw just the half circle placed exactly at the last or first point of line. We need to calculate the exact angle we should start our circle fragment from,</p> <p><img src="http://www.merowing.info/uploads/2012/04/figure_3.png" width="320" height="240"></p> <p>As you can see here, we need to figure out what angle of our circle is pointing at C ( Circle is not rotated, it’s just placed at the end point ) , again we can use Perpendicular to line direction to calculate that. I like dot products, so let’s use them to calculate the angle.</p> <div> <button class='toggle-code' title='show'>Show Code</button><figure class='code hide'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">CGPoint</span> <span class="n">perpendicular</span> <span class="o">=</span> <span class="n">ccpPerp</span><span class="p">(</span><span class="n">aLineDir</span><span class="p">);</span>
</span><span class='line'><span class="kt">float</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">acosf</span><span class="p">(</span><span class="n">ccpDot</span><span class="p">(</span><span class="n">perpendicular</span><span class="p">,</span> <span class="n">CGPointMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
</span><span class='line'><span class="kt">float</span> <span class="n">rightDot</span> <span class="o">=</span> <span class="n">ccpDot</span><span class="p">(</span><span class="n">perpendicular</span><span class="p">,</span> <span class="n">CGPointMake</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">rightDot</span> <span class="o">&lt;</span> <span class="mf">0.0f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">angle</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> </div> <p>As you probably remember from school the value of dot product of normalized vectors is equal to cos angle between them, we will calculate dot product between the perpendicular to line direction and vector (0, 1). Since we also need to take into consideration the direction of our angle, we should also calculate dot product between perpendicular and right vector, then according to that we can modify the angle. When calculating aLineDir make sure that for start of the line you reverse the direction. The final result of our algorithm should look like this:</p> <p><img src="http://www.merowing.info/uploads/2012/04/Step_4.png" width="320" height="240"></p> <h2>Conclusion</h2> <p><a href="https://github.com/krzysztofzablocki/smooth-drawing">Download project from GitHub.</a>At this point we have a really nice drawing application. I decided to share my solution because I couldn’t find a complete one shared by anyone else… I’m sure it could be improved even more I just don’t have more time to spend on it and I’m pretty pleased with how it works right now, if you manage to improve any parts or find any bug make sure you will send me a pull request on GitHub. I hope you liked it!</p> <p>I&#8217;m <a href="http://twitter.com/merowing_">merowing_ on twitter</a> if you feel like talking about it.</p> </div> </article> <div class="share"> <div class="addthis_sharing_toolbox"></div> <script type="text/javascript">
var addthis_share = addthis_share || {}
addthis_share = {
passthrough : {
twitter: {
via: "merowing_",
text: "Great article"
}
}
}
</script> <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script> <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-532368630eb37492" async></script> </div> </div> </div> <footer id="footer" class="inner">Copyright &copy; 2015 Krzysztof Zabłocki Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer> <script src="/javascripts/slash.js"></script> <script src="/javascripts/code-toggle.js"></script> <script src="/javascripts/jquery.fancybox.pack.js"></script> <script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-29400340-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();

		$('a').click(function() { 
			var $a = $(this); var href = $a.attr('href');
			// see if the link is external 
			if ( (href.match(/^http/)) && (! href.match(document.domain)) ) {

			// if so, register an event
			var category = 'outgoing'; // set this to whatever you want
			var event = 'click'; // set this to whatever you want
			var label = href; // set this to whatever you want
			pageTracker._trackEvent(category, event, href);
			}});
	</script> </div> </div> </body> </html>